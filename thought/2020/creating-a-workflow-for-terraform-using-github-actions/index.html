<!doctype html><html><head><title>Creating a workflow for Terraform using GitHub Actions - Mijndert Stuij</title><meta charset=utf-8><meta name=description content="How to connect Terraform and GitHub Actions together."><meta name=google-site-verification content="saUIHjzun9dAGQ4-YTEb0W_vLiFRM1sEiHZXPCCOmyc"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=apple-mobile-web-app-title content="Mijndert Stuij"><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><link rel=canonical href=https://mijndertstuij.nl/thought/2020/creating-a-workflow-for-terraform-using-github-actions/><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/css/syntax.css><link rel="shortcut icon" href=/favicon.ico></head><body><header class=bio><a href=https://mijndertstuij.nl>back</a></header><article><header class=header><h1>Creating a workflow for Terraform using GitHub Actions</h1><div><time>MAY 8, 2020</time></div></header><p>Recently I started working with Terraform more and more, as CloudFormation is lagging behind in terms of support for newer AWS services. Terraform has quite a steep learning curve, but once it <em>clicks</em> you never want to go back to the old days.</p><p>I created a <a href=https://github.com/mijndert/terraform>public repository</a> up on GitHub so I can play around with Terraform and other related tools. This week <a href=https://githubsatellite.com/>GitHub Satellite</a> is on, which brought us a much needed feature: a proper GitHub Action for working with Terraform in a CI/CD pipeline. The action is called <a href=https://www.terraform.io/docs/github-actions/setup-terraform.html>setup-terraform</a> and is available right now.</p><p>Here&rsquo;s how it works.</p><p>If you take a look at <a href=https://github.com/mijndert/terraform>my repository</a> you can see I&rsquo;ve built a simple VPC module which I&rsquo;m calling from <code>vpc.tf</code> in the root of the repository. Before you dive in, you first have to configure <a href=https://help.github.com/en/actions/configuring-and-managing-workflows/creating-and-storing-encrypted-secrets>Secrets</a>. Secrets is where you will store your AWS credentials so Terraform can reach your environment and roll out changes if needed.</p><h2 id=setting-up-secrets>Setting up Secrets</h2><p>Head to your GitHub repository settings where your Terraform templates are stored. In the left sidebar you&rsquo;ll find Secrets. We&rsquo;ll need three Secrets for the workflow to work:</p><ul><li><code>AWS_ACCESS_KEY_ID</code></li><li><code>AWS_SECRET_ACCESS_KEY</code></li><li><code>AWS_REGION</code> (example: eu-west-1)</li></ul><p>Have a look at <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html>the documentation</a> if you want to know how to obtain AWS credentials.</p><h2 id=breaking-down-the-workflow>Breaking down the workflow</h2><p>Now that we&rsquo;ve got our Secrets set up, we can create a GitHub Action. In your GitHub repository, select Actions from the top menu and click <em>set up a workflow yourself</em>.</p><p>Let&rsquo;s break down each step.</p><p>This GitHub Action will run on Ubuntu and will invoke a bash shell so we can set environment variables.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>terraform</span>:
  <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#39;Terraform&#39;</span>
  <span style=color:#f92672>runs-on</span>: <span style=color:#ae81ff>ubuntu-latest</span>

  <span style=color:#f92672>defaults</span>:
    <span style=color:#f92672>run</span>:
      <span style=color:#f92672>shell</span>: <span style=color:#ae81ff>bash</span>
</code></pre></div><p>The following step will install Terraform.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Setup Terraform</span>
  <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>hashicorp/setup-terraform@v1</span>
</code></pre></div><p>This is how the Action will use the Secrets you configured earlier to set environement variables. Terraform will use these credentials to talk to AWS' API.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Configure AWS credentials</span>
  <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>aws-actions/configure-aws-credentials@v1</span>
  <span style=color:#f92672>with</span>:
    <span style=color:#f92672>aws-access-key-id</span>: <span style=color:#ae81ff>${{ secrets.AWS_ACCESS_KEY_ID }}</span>
    <span style=color:#f92672>aws-secret-access-key</span>: <span style=color:#ae81ff>${{ secrets.AWS_SECRET_ACCESS_KEY }}</span>
    <span style=color:#f92672>aws-region</span>: <span style=color:#ae81ff>${{ secrets.AWS_REGION }}</span>
</code></pre></div><p>Once we have Terraform set up and the credentials loaded as environment variables we can run all commands you&rsquo;re familiar with from running Terraform locally.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Terraform init</span>
  <span style=color:#f92672>run</span>: <span style=color:#ae81ff>terraform init</span>
- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Terraform validate</span>
  <span style=color:#f92672>run</span>: <span style=color:#ae81ff>terraform validate</span>
- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Terraform format</span>
  <span style=color:#f92672>run</span>: <span style=color:#ae81ff>terraform fmt -check</span>
- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Terraform plan</span>
  <span style=color:#f92672>run</span>: <span style=color:#ae81ff>terraform plan</span>
</code></pre></div><p>If you work with proper a proper Git branching strategy and make sure code <a href=https://help.github.com/en/github/administering-a-repository/about-protected-branches>only gets into master</a> using pull requests, you can also <code>terraform apply</code> right from your workflow.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Terraform Apply</span>
  <span style=color:#f92672>if</span>: <span style=color:#ae81ff>github.ref == &#39;refs/heads/master&#39; &amp;&amp; github.event_name == &#39;push&#39;</span>
  <span style=color:#f92672>run</span>: <span style=color:#ae81ff>terraform apply -auto-approve</span>
</code></pre></div><p>Using <a href=https://github.com/mijndert/terraform/blob/master/.github/workflows/terraform.yml>this workflow</a> in GitHub Actions you have a fully automated CI/CD pipeline that will validate your code, and even deploy changes to the correct environment when everything checks out. Of course you can go crazy with multiple environments and repositories but these are the basics. Try it out, I&rsquo;d love to see what you do with it.</p></article></body></html>