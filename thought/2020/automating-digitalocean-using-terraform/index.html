<!doctype html><html lang=en><head><title>Automating Digitalocean using Terraform - Mijndert Stuij</title><meta charset=utf-8><meta name=description content="Employing infrastructure as code to save a few clicks."><meta name=google-site-verification content="saUIHjzun9dAGQ4-YTEb0W_vLiFRM1sEiHZXPCCOmyc"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=apple-mobile-web-app-title content="Mijndert Stuij"><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><link rel=canonical href=https://mijndertstuij.nl/thought/2020/automating-digitalocean-using-terraform/><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/css/syntax.css><link rel="shortcut icon" href=/favicon.ico></head><body><header class=bio><a href=https://mijndertstuij.nl>back</a></header><article><header class=header><h1>Automating Digitalocean using Terraform</h1><div><time>DEC 29, 2020</time></div></header><p>I&rsquo;ve been an AWS engineer/consultant for 13 years already, but <a href=https://m.do.co/c/7333c5d3f093>Digitalocean</a> will always be my go-to for personal projects. AWS is usually too complicated and expensive a platform for my needs. Sometimes I just need a quick VM to test some stuff out, or get something on the internet quickly.</p><p>I&rsquo;ve had a shell script that bootstraps my Linux VM&rsquo;s for the longest time, it installs a bunch of packages, creates users, configures the timezone and much more. But the process of creating a new Droplet was still something I did by hand. Now, I&rsquo;ve had quite a bit of experience with Terraform, I&rsquo;ve been using it at a few different clients for AWS deployments after all. Luckily, there&rsquo;s a <a href=https://registry.terraform.io/providers/digitalocean/digitalocean/latest>Terraform provider for Digitalocean</a> as well, and it&rsquo;s pretty awesome.</p><p>I went looking for examples on how other people used Terraform to deploy Droplets and Kubernetes clusters on Digitalocean. What I found however was a whole load of outdated code. Since those articles were written both Terraform and the Digitalocean provider had seen significant changes.</p><p>I created my own quickstarts to make it just that much easier to work with Digitalocean: meet <a href=https://github.com/mijndert/jaws>Jaws</a> and <a href=https://github.com/mijndert/wheel>Wheel</a>.</p><p>Here&rsquo;s what I learned along the way.</p><h2 id=installing-terraform>Installing Terraform</h2><p><strong>macOS</strong></p><p>Install using <a href=https://brew.sh/>Homebrew</a>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>brew tap hashicorp/tap
brew install hashicorp/tap/terraform
</code></pre></div><p><strong>Windows</strong></p><p>Install using <a href=https://chocolatey.org/>Chocolatey</a>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>choco install terraform
</code></pre></div><p><strong>Ubuntu</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
sudo apt-add-repository <span style=color:#e6db74>&#34;deb [arch=amd64] https://apt.releases.hashicorp.com </span><span style=color:#66d9ef>$(</span>lsb_release -cs<span style=color:#66d9ef>)</span><span style=color:#e6db74> main&#34;</span>
sudo apt-get update <span style=color:#f92672>&amp;&amp;</span> sudo apt-get install terraform
</code></pre></div><h2 id=credentials>Credentials</h2><p>In order to interface with the Digitalocean API you need a <a href=https://cloud.digitalocean.com/account/api/tokens>Personal access token</a>. This token should be kept safe since it will grant read and write access to your Digitalocean account.</p><p>You can make the token available in your CLI by setting an environment variable:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>export DIGITALOCEAN_ACCESS_TOKEN<span style=color:#f92672>=</span>&lt;personal access token&gt;
</code></pre></div><p>Older versions of the Digitalocean provider seemed to not automatically look for this environment variable, the latest one most definitly does. All you need to do to set up the provider is:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>terraform</span> {
  <span style=color:#66d9ef>required_providers</span> {
    digitalocean <span style=color:#f92672>=</span> {
      source <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;digitalocean/digitalocean&#34;</span>
      version <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;~&gt; 2.3&#34;</span>
    }
  }
}
</code></pre></div><h2 id=getting-information-from-the-api>Getting information from the API</h2><p>When you want to launch for example a Droplet you need to know the names of both Images and Droplet sizes. The provider documentation doesn&rsquo;t make it abundantly clear what the values can and should be. You can look at the API documentation, but you can also ask the API directly:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -X GET --silent <span style=color:#e6db74>&#34;https://api.digitalocean.com/v2/images?per_page=999&#34;</span> -H <span style=color:#e6db74>&#34;Authorization: Bearer </span>$DIGITALOCEAN_ACCESS_TOKEN<span style=color:#e6db74>&#34;</span> |jq <span style=color:#e6db74>&#39;.&#39;</span>
</code></pre></div><h2 id=adding-an-ssh-key>Adding an SSH key</h2><p>You can add your own SSH key for authentication to each Droplet you launch. Using Terraform it&rsquo;s really easy to add your own:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;digitalocean_ssh_key&#34; &#34;this&#34;</span> {
  name               <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Terraform Example&#34;</span>
  public_key         <span style=color:#f92672>=</span> <span style=color:#66d9ef>file</span>(<span style=color:#e6db74>&#34;~/.ssh/id_rsa.pub&#34;</span>)
}
</code></pre></div><p>When you create a Droplet you can now point to this SSH key&rsquo;s fingerprint to add it at runtime:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ssh_keys <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>digitalocean_ssh_key.this.fingerprint<span style=color:#f92672>]</span>
</code></pre></div><h2 id=the-digitalocean-provider-is-really-simple-and-elegant>The Digitalocean provider is really simple and elegant</h2><p>While the documentation could definitely be improved I&rsquo;ll start with infrastructure-as-code first for all of my Digitalocean needs. It&rsquo;s just too simple to add a Droplet, create a Kubernetes cluster or configure a Cloud Firewall. Using Terraform will also allow me to more efficiently remove unused resources. When I create resources by hand it&rsquo;s a bit cumbersome to go back and delete everything once I&rsquo;m done.</p><p>If you want to learn more about Terraform I recommend you start with the <a href=https://www.terraform.io/intro/index.html>getting started guide</a>. It explains in detail what Terraform is and how you can get started using it for all kinds of different use-cases.</p></article><section class=footer><p>The opinions on this site are my own. They do not necessarily represent those of my employer.</p><p>mijndert@mijndertstuij.nl</p></section></body></html>