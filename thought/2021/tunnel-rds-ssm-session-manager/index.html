<!doctype html><html lang=en><head><title>Tunnel to RDS via SSM Session Manager - Mijndert Stuij</title><meta charset=utf-8><meta name=description content="How to create an SSH tunnel via SSM Session Manager to access private resources like RDS without opening port 22."><meta name=google-site-verification content="saUIHjzun9dAGQ4-YTEb0W_vLiFRM1sEiHZXPCCOmyc"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=apple-mobile-web-app-title content="Mijndert Stuij"><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><link rel=canonical href=https://mijndertstuij.nl/thought/2021/tunnel-rds-ssm-session-manager/><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/css/syntax.css><link rel="shortcut icon" href=/favicon.ico></head><body><header class=bio><a href=https://mijndertstuij.nl>back</a></header><article><header class=header><h1>Tunnel to RDS via SSM Session Manager</h1><div><time>MAY 14, 2021</time></div></header><p>AWS Systems Manager is a suite of tools to make administration of, mostly, EC2 instances a little easier. One of things in SSM&rsquo;s toolbox is Session Manager which allows you to connect to an EC2 instance without opening any ports in your security groups.</p><p>You can also use Session Manager to create an SSH tunnel to infrastructure in private subnets, like RDS or Redis.</p><p>To make use of SSM, an agent has to be installed on the target EC2 instance, this agent is installed by default on Amazon Linux 2 and a bunch of more recent Ubuntu versions. To follow along it&rsquo;s best to launch an EC2 instance using the latest Amazon Linux 2 AMI since it has all prerequisites installed by default.</p><h2 id=generate-an-ssh-key>Generate an SSH key</h2><p>Since we&rsquo;ll use an SSH tunnel we&rsquo;ll also need an SSH key to use it with. Currently the most secure SSH key possible uses the ed25519 algorithm. You can generate a new key like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ssh-keygen -o -a <span style=color:#ae81ff>100</span> -t ed25519 -f ~/.ssh/id_ed25519
</code></pre></div><blockquote><p>Note: It&rsquo;s generally a good idea to set a password on your SSH keys. Store the password in a password manager since it can&rsquo;t be recovered. Losing your password means generating a new SSH key.</p></blockquote><h2 id=launch-instance-connect>Launch instance connect</h2><p>In order to launch instance connect you need to know the following 2 things about the instance:</p><ol><li>The Availability Zone the instance is in;</li><li>The ID of the instance</li></ol><p>Let&rsquo;s say you have an instance with ID i-123456789 in eu-west-1a.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>aws ec2-instance-connect <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    send-ssh-public-key <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --availability-zone eu-west-1a <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --instance-id i-123456789 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --instance-os-user ssm-user <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --ssh-public-key file://$HOME/.ssh/id_ed25519.pub
</code></pre></div><p>This will start a foreground process that initiates instance connect so keep your terminal open for the next step.</p><blockquote><p>When you&rsquo;re done you can quit the process by hitting ctrl+c.</p></blockquote><h2 id=open-an-ssh-tunnel>Open an SSH tunnel</h2><p>Now we can open up an SSH tunnel as you would otherwise. In this case I use the aforementioned EC2 instance to connect to an RDS instance over port 3306, both local as well as rmeote.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ssh ssm-user@i-123456789 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    -NL 3306:&lt;RDS connection string&gt;:3306
</code></pre></div><p>Now you should be able to connect to the RDS instance in a private subnet by connecting to <code>localhost:3306</code> from your workstation.</p></article><section class=footer><p>The opinions on this site are my own. They do not necessarily represent those of my employer.</p><p>mijndert@mijndertstuij.nl</p></section><style>@font-face{font-family:ibm plex mono;font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v6/-F63fjptAgt5VM-kVkqdyU8n1iEq131nj-otFQ.woff2)format('woff2');unicode-range:U+100-24F,U+259,U+1E??,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:ibm plex mono;font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v6/-F63fjptAgt5VM-kVkqdyU8n1i8q131nj-o.woff2)format('woff2');unicode-range:U+??,U+131,U+152-153,U+2BB-2BC,U+2C6,U+2DA,U+2DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:ibm plex mono;font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v6/-F6qfjptAgt5VM-kVkqdyU8n3pQPwl5FgsAXHNlYzg.woff2)format('woff2');unicode-range:U+100-24F,U+259,U+1E??,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:ibm plex mono;font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/ibmplexmono/v6/-F6qfjptAgt5VM-kVkqdyU8n3pQPwlBFgsAXHNk.woff2)format('woff2');unicode-range:U+??,U+131,U+152-153,U+2BB-2BC,U+2C6,U+2DA,U+2DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></body></html>