<!doctype html><html lang=en><head><title>Tunnel to RDS via SSM Session Manager - Mijndert Stuij</title><meta charset=utf-8><meta name=description content="How to create an SSH tunnel via SSM Session Manager to access private resources like RDS without opening port 22."><meta name=google-site-verification content="saUIHjzun9dAGQ4-YTEb0W_vLiFRM1sEiHZXPCCOmyc"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=apple-mobile-web-app-title content="Mijndert Stuij"><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><link rel=canonical href=https://mijndertstuij.nl/thought/2021/tunnel-rds-ssm-session-manager/><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/css/syntax.css><link rel="shortcut icon" href=/favicon.ico></head><body><header class=bio><a href=https://mijndertstuij.nl>back</a></header><article><header class=header><h1>Tunnel to RDS via SSM Session Manager</h1><div><time>MAY 14, 2021</time></div></header><p>AWS Systems Manager is a suite of tools to make administration of, mostly, EC2 instances a little easier. One of things in SSM&rsquo;s toolbox is Session Manager which allows you to connect to an EC2 instance without opening any ports in your security groups.</p><p>You can also use Session Manager to create an SSH tunnel to infrastructure in private subnets, like RDS or Redis.</p><p>To make use of SSM, an agent has to be installed on the target EC2 instance, this agent is installed by default on Amazon Linux 2 and a bunch of more recent Ubuntu versions. To follow along it&rsquo;s best to launch an EC2 instance using the latest Amazon Linux 2 AMI since it has all prerequisites installed by default.</p><h2 id=generate-an-ssh-key>Generate an SSH key</h2><p>Since we&rsquo;ll use an SSH tunnel we&rsquo;ll also need an SSH key to use it with. Currently the most secure SSH key possible uses the ed25519 algorithm. You can generate a new key like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ssh-keygen -o -a <span style=color:#ae81ff>100</span> -t ed25519 -f ~/.ssh/id_ed25519
</code></pre></div><blockquote><p>Note: It&rsquo;s generally a good idea to set a password on your SSH keys. Store the password in a password manager since it can&rsquo;t be recovered. Losing your password means generating a new SSH key.</p></blockquote><h2 id=launch-instance-connect>Launch instance connect</h2><p>In order to launch instance connect you need to know the following 2 things about the instance:</p><ol><li>The Availability Zone the instance is in;</li><li>The ID of the instance</li></ol><p>Let&rsquo;s say you have an instance with ID i-123456789 in eu-west-1a.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>aws ec2-instance-connect <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    send-ssh-public-key <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --availability-zone eu-west-1a <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --instance-id i-123456789 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --instance-os-user ssm-user <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --ssh-public-key file://$HOME/.ssh/id_ed25519.pub
</code></pre></div><p>This will start a foreground process that initiates instance connect so keep your terminal open for the next step.</p><blockquote><p>When you&rsquo;re done you can quit the process by hitting ctrl+c.</p></blockquote><h2 id=open-an-ssh-tunnel>Open an SSH tunnel</h2><p>Now we can open up an SSH tunnel as you would otherwise. In this case I use the aforementioned EC2 instance to connect to an RDS instance over port 3306, both local as well as rmeote.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ssh ssm-user@i-123456789 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    -NL 3306:&lt;RDS connection string&gt;:3306
</code></pre></div><p>Now you should be able to connect to the RDS instance in a private subnet by connecting to <code>localhost:3306</code> from your workstation.</p><h2 id=putting-it-all-together>Putting it all together</h2><p>To make initiating a tunnel a little bit easier I wrote a quick Bash script that looks up the instance ID and the AZ of your bastion host. In this case is looks for the EC2 instance based on the Name tag, but of course it can be any tag you like.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#!/bin/bash
</span><span style=color:#75715e></span>
green<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>tput setaf 2<span style=color:#e6db74>`</span>
reset<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>tput sgr0<span style=color:#e6db74>`</span>

echo <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>green<span style=color:#e6db74>}</span><span style=color:#e6db74>Hostname of the resource you want to connect to:</span><span style=color:#e6db74>${</span>reset<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
read -e hostname
echo <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>green<span style=color:#e6db74>}</span><span style=color:#e6db74>Port of the thing you want to connect to:</span><span style=color:#e6db74>${</span>reset<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
read -e port
echo <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>green<span style=color:#e6db74>}</span><span style=color:#e6db74>Connecting (quit with ctrl+c)</span><span style=color:#e6db74>${</span>reset<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>

export ID<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>aws ec2 describe-instances --output<span style=color:#f92672>=</span>text --query <span style=color:#e6db74>&#34;Reservations[*].Instances[*].InstanceId&#34;</span> --filters Name<span style=color:#f92672>=</span>tag:Name,Values<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;BastionStack*&#34;</span><span style=color:#66d9ef>)</span>
export AZ<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>aws ec2 describe-instances --output text --query <span style=color:#e6db74>&#39;Reservations[*].Instances[*].[Placement.AvailabilityZone]&#39;</span> --filters Name<span style=color:#f92672>=</span>tag:Name,Values<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;BastionStack*&#34;</span><span style=color:#66d9ef>)</span>

aws ec2-instance-connect <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    send-ssh-public-key <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --availability-zone $AZ <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --instance-id $ID <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --instance-os-user ssm-user <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --ssh-public-key file://$HOME/.ssh/id_ed25519.pub &amp;&gt;/dev/null &amp; disown;

ssh ssm-user@$ID -NL $port<span style=color:#ae81ff>\:</span>$hostname<span style=color:#ae81ff>\:</span>$port
</code></pre></div></article><section class=footer><p>The opinions on this site are my own. They do not necessarily represent those of my employer.</p><p>mijndert@mijndertstuij.nl</p></section></body></html>